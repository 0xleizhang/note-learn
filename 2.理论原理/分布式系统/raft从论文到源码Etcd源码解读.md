\# æ¦‚å¿µ
æ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿ

å…³é”®æ€æƒ³ï¼šå°‘æ•°æœä»å¤šæ•° quorum

\### ç®—æ³•è¿˜æ˜¯åè®®ï¼Ÿ
raft is Algorithm? è§raft.github.io

![image.png](assert/1636556192638-a15bb32f-94d1-48d5-b1a8-d9369b8aa48a.png)

raft is Protocol ?è§etcdæ–‡æ¡£

![image.png](assert/1636556127890-3dcabf0f-36d4-426e-bfd9-6ea4ecef2460.png)

å…¶å®ä¸¤ç§è¯´æ³•éƒ½å¯¹ï¼Œåè®®å¼ºè°ƒçš„æ˜¯å®ç°æ˜¯èŠ‚ç‚¹é—´é€šä¿¡è¿‡ç¨‹ï¼Œç®—æ³•è¯­å¢ƒä¸€èˆ¬åœ¨ç†è®º

\### ä¸€è‡´æ€§è¿˜æ˜¯å…±è¯†ï¼Ÿä»€ä¹ˆæ˜¯ä¸€è‡´æ€§ï¼Ÿ
Consensus n. å¤šç¿»è¯‘æˆå…±è¯†

Consistent adj. å¤šç¿»è¯‘æˆä¸€è‡´æ€§ å½¢å®¹è¯

è®ºæ–‡ä¸­å¤šæ•°ç”¨çš„æ˜¯consensusï¼ŒconsistentæŒ‡log consistent æ—¥å¿—å‰¯æœ¬ä¸€è‡´æ€§

åº”è¯¥è¯´ï¼šraftå…±è¯†ç®—æ³•å–å¾—æ—¥å¿—å‰¯æœ¬ä¸€è‡´æ€§

å…±è¯†æ˜¯ç³»ç»Ÿå®ç°å±‚é¢æè¿°ï¼Œä¸€è‡´æ€§æ˜¯åº”ç”¨ä¸šåŠ¡å±‚é¢æè¿°

æˆ–è€…è¯´æ˜¯ä¸€ç§å®¹é”™ç³»ç»Ÿfault tolerance

![image.png](assert/1636556796341-c7faeb65-a194-4794-ae1d-70c387e9d467.png)

![image.png](assert/1636556763756-6fd4ec6c-e423-49f9-ac8c-5422bfa949ea.png)

â€‹

åŒºåˆ†å…¶ä»–é¢†åŸŸçš„ä¸€è‡´æ€§\\* æ¦‚å¿µï¼Œä¸è¦æ··æ·†ã€‚å…·ä½“æ‰€æŒ‡ä¸åŒã€‚

å…¶ä»–é¢†åŸŸçš„ä¸€è‡´æ€§ï¼šä¸€è‡´æ€§å“ˆå¸Œï¼Œæ•°æ®åº“ACIDä¸­ä¸€è‡´æ€§ï¼ŒCAPä¸­çš„ä¸€è‡´æ€§
\> ä¸€è‡´æ€§æ™—å¸Œ

ä¸€è‡´æ€§å“ˆå¸Œ ï¼Œ ç”±Kargerç­‰äººé¦–å…ˆæå‡º[7]ï¼Œæ˜¯ä¸€ç§å¹³å‡ åˆ†è‡ªå·±è´Ÿè½½çš„æ–¹æ³•ï¼Œæœ€åˆç”¨ äº å†…å®¹åˆ†å‘ç½‘ç»œ( CDN)ç­‰äº’è”ç½‘ç¼“å­˜ç³»ç»Ÿ ã€‚ å®ƒé‡‡ç”¨éšæœºé€‰æ‹©çš„åˆ†åŒºè¾¹ç•Œæœªè§„é¿ ä¸­å¤®æ§åˆ¶æˆ–åˆ†å¸ƒå¼å…±è¯† ã€‚ è¯·æ³¨æ„ï¼Œæ­¤å¤„çš„ä¸€è‡´æ€§ä¸å‰¯æœ¬ä¸€è‡´æ€§(ç¬¬ 5ç« )æˆ– ACID
\> ä¸€è‡´æ€§(ç¬¬ 7ç« )æ²¡æœ‰ä»»ä½•å…³è” ï¼Œå®ƒåªæè¿°äº†æ•°æ®åŠ¨æ€å¹³è¡¡çš„ ä¸€ç§æ–¹æ³• ã€‚
> æ­£å¦‚åé¢ â€œåˆ†åŒºå†å¹³è¡¡â€ ä¸€èŠ‚å°†å¦¥ä»‹ç»çš„ï¼Œè¿™ç§ç‰¹ æ®Šçš„åˆ†åŒºæ–¹æ³•å¯¹ äº æ•°æ®åº“å®é™… æ•ˆæœå¹¶ä¸æ˜¯å¾ˆå¥½ï¼Œæ‰€ä»¥ç›®å‰å¾ˆå°‘ä½¿ç”¨(è™½ç„¶æŸäº›æ•°æ®åº“çš„ä¹‰æ¡£ä»é‡‡ç”¨ ä¸€æ•ˆæ€§å“ˆå¸Œ çš„æœ¯è¯­ï¼Œä½†å…¶å®å¹¶ä¸å‡†ç¡®) ã€‚ ä¸ºé¿å…æ··æ·†ï¼Œæˆ‘ä»¬æ­¤å¤„åªç”¨æœ¯è¯­å“ˆå¸Œåˆ†åŒºã€‚
>
\> -----ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿè®¾è®¡ã€‹ç¬¬å…­ç« é”®-å€¼æ•°æ®çš„åˆ†åŒº

\###

\### æå‡ºæ—¶è¦è§£å†³çš„é—®é¢˜ï¼Ÿ
[![image.png](assert/1636943701938-b906c92a-2ce2-4b3f-9f0c-88d00ecba628.png)
\> ç®—æ³•çš„è®¾è®¡é€šå¸¸ä¼šæŠŠæ­£ç¡®æ€§ï¼Œæ•ˆç‡æˆ–è€…ç®€æ´ä½œä¸ºä¸»è¦çš„ç›®æ ‡ã€‚å°½ç®¡è¿™äº›éƒ½æ˜¯å¾ˆæœ‰æ„ä¹‰çš„ç›®æ ‡ï¼Œä½†æ˜¯æˆ‘ä»¬ç›¸ä¿¡ï¼Œå¯ç†è§£æ€§ä¹Ÿæ˜¯ä¸€æ ·çš„é‡è¦ã€‚åœ¨å¼€å‘è€…æŠŠç®—æ³•åº”ç”¨åˆ°å®é™…çš„ç³»ç»Ÿä¸­ä¹‹å‰ï¼Œè¿™äº›ç›®æ ‡æ²¡æœ‰ä¸€ä¸ªä¼šè¢«å®ç°ï¼Œè¿™äº›éƒ½ä¼šå¿…ç„¶çš„åç¦»å‘è¡¨æ—¶çš„å½¢å¼ã€‚é™¤éå¼€å‘äººå‘˜å¯¹è¿™ä¸ªç®—æ³•æœ‰ç€å¾ˆæ·±çš„ç†è§£å¹¶ä¸”æœ‰ç€ç›´è§‚çš„æ„Ÿè§‰ï¼Œå¦åˆ™å°†ä¼šå¯¹ä»–ä»¬è€Œè¨€å¾ˆéš¾åœ¨å®ç°çš„æ—¶å€™ä¿æŒåŸæœ‰æœŸæœ›çš„ç‰¹æ€§ã€‚

ä¸ºäº†è§£å†³Paxosç®—æ³•å¤æ‚éš¾ç†è§£ï¼Œéš¾æ•™å­¦ï¼Œéš¾å®ç°çš„é—®é¢˜

raftè§£å†³è¿™ä¸ªé—®é¢˜çš„æ‰‹æ®µä¸»è¦æœ‰ä¸¤ä¸ªï¼š

1 æ‹†è§£å­é—®é¢˜ï¼Œå…·ä½“ä¸ºï¼š\*\*ä¸»èŠ‚ç‚¹é€‰ä¸¾Leader electionï¼Œæ—¥å¿—å¤åˆ¶ Log Replicationï¼ŒSafety å®‰å…¨è§„åˆ™ï¼Œé›†ç¾¤æˆå‘˜å˜åŒ–\*\*

2 å‡å°‘çŠ¶æ€ç©ºé—´ [ref](https://bbs.huaweicloud.com/blogs/107807) éšæ—¶æ—¶é—´å¼€å§‹é€‰ä¸¾

â€‹

\### å­é—®é¢˜ä¸ºä»€ä¹ˆæ˜¯é€‰ä¸¾ã€æ—¥å¿—å¤åˆ¶ï¼Ÿ
è¿™é‡Œä¸¾ä¸€ä¸ªä¾‹å­æ¥è§£é‡Šè¿™ä¸ªé—®é¢˜ã€‚

å‡è®¾ä¸‰ä¸ªèŠ‚ç‚¹ A B C å­˜å‚¨ç”¨æˆ·èµ„é‡‘è´¦æˆ·

\*\*é˜¶æ®µä¸€\*\*

åˆå§‹çŠ¶æ€æ‰€æœ‰è´¦æˆ·èµ„é‡‘ä¸ºé›¶ï¼Œæˆ‘ä»¬å…è®¸A B C åŒæ—¶éƒ½èƒ½å¤„ç†ç”¨æˆ·è¯·æ±‚ï¼Œå°èœï¼ˆå®¢æˆ·ç«¯ï¼‰è¯·æ±‚A èŠ‚ç‚¹ å­˜å…¥ 100ï¼Œä¸ºäº†è®©Bä¹Ÿèƒ½æ­£å¸¸å¤„ç†ï¼Œé‚£ä¹ˆéœ€è¦Aå°†äº¤æ˜“è®°å½•ï¼ˆæ—¥å¿—ï¼‰å¤åˆ¶ç»™ B C èŠ‚ç‚¹ï¼Œå°èœåˆè¯·æ±‚B èŠ‚ç‚¹è¦ä»è´¦æˆ·å–100

å¦‚æœAæ€»æ˜¯èƒ½å°†æ—¥å¿—æˆåŠŸå¤åˆ¶åˆ°Bã€Cï¼Œå¹¶ä¸”å–æ“ä½œæ€»æ˜¯åœ¨å­˜å…¥ä¹‹åï¼Œå¤„ç†æ˜¯æ­£ç¡®çš„
\`\`\`
ç†æƒ³æ—¶åº
æ“ä½œ æ—¶é—´ ä½™é¢
å­˜100 t1 A=100
Aå¤åˆ¶æ—¥å¿—åˆ°B t2 B=100
Aå¤åˆ¶æ—¥å¿—åˆ°C t3 B=100
å–100 t4 B=0
Bå¤åˆ¶åˆ°AC...

å¯èƒ½æ—¶åº
æ“ä½œ æ—¶é—´ ä½™é¢
Aå­˜100 t1 A=100
Aå¤åˆ¶æ—¥å¿—åˆ°C t2 C=100
Bå–100 t3 âŒ ERROR -100
Aå¤åˆ¶æ—¥å¿—åˆ°B t4 B=100

if t1ä½†æ˜¯é‰´äºç½‘ç»œçš„ä¸å¯é å’Œæ‰€æœ‰æœºå™¨çš„æ—¶é’Ÿï¼ˆå³ä½¿ä½¿ç”¨åŸå­é’Ÿï¼‰ä¸å¯èƒ½å®Œå…¨ä¸€æ ·ï¼Œä¸å¯èƒ½å–å¾—å…¨å±€æ—¶åºã€‚æ¢å¥è¯è¯´å‘ç”Ÿåœ¨Açš„æ—¥å¿—æ—¶é—´t1å’Œå‘ç”Ÿåœ¨Bçš„æ—¥å¿—æ—¶é—´t4 \*\*æ— æ³•æ­£ç¡®åˆ¤æ–­\*\*å¤§å°å…³ç³»

â€‹

ğŸ‘‚ï¼šå…±è¯†=å…¨å±€æ—¥å¿—é¡ºåºä¸€è‡´

\*\*é˜¶æ®µäºŒ\*\*

æ—¢ç„¶ A B C æä¸å®šé¡ºåºä¸€è‡´ï¼Œå¦‚æœæŒ‡å®šä¸€ä¸ªä¸»èŠ‚ç‚¹Aï¼Œ æ‰€æœ‰å®¢æˆ·ç«¯å¤„ç†éƒ½ç»ç”±ä»–ï¼Œå†å°†æ—¥å¿—å¤åˆ¶ç»™Bã€C ï¼Œé¡ºåºä¸å°±èƒ½ä¿è¯äº†ã€‚

é¡ºåºæ˜¯ä¿è¯äº†ï¼Œä½†æ˜¯æˆ‘ä»¬é…ç½®åˆ°èŠ‚ç‚¹Aå¯èƒ½ä¼šå®•æœº

â€‹

\*\*é˜¶æ®µä¸‰\*\*

é€‰ä¸¾å°±æ¥äº†ï¼Œæ—¢ç„¶Aå®•æœºäº†ï¼Œå‰©ä¸‹çš„èŠ‚ç‚¹\*\*è‡ªåŠ¨\*\*é€‰ä¸¾ä¸€ä¸ªèŠ‚ç‚¹ç»§ç»­ä½œä¸ºä¸»èŠ‚ç‚¹

ç³»ç»Ÿæœ€ç»ˆçš„ç›®çš„æ˜¯å…¨å±€æ—¥å¿—é¡ºåºä¸€è‡´ï¼Œå¹¶ä¸”å®¢æˆ·ç«¯æäº¤æˆåŠŸçš„æ—¥å¿—ä¸ä¸¢å¤±ã€‚

å…·ä½“é€‰ä¸¾è¿‡ç¨‹ï¼Œåœ¨æ·±å…¥å­é—®é¢˜ç»†èŠ‚ï¼šé€‰ä¸¾è¿‡ç¨‹æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ

æ€»ç»“ï¼š

å…±è¯†æ¥è‡ªä¸»èŠ‚ç‚¹çš„ç‹¬è£ï¼Œé€‰ä¸¾äº§ç”Ÿä¸»èŠ‚ç‚¹

å•ä¸ªèŠ‚ç‚¹æ²¡æœ‰å…±è¯†é—®é¢˜ï¼ŒæŒ‡å®šçš„ä¸»èŠ‚ç‚¹æ²¡æœ‰å…±è¯†é—®é¢˜ï¼Œä½†æ˜¯æŒ‡å®šçš„ä¸»èŠ‚ç‚¹ä¼šæŒ‚ï¼Œéœ€è¦æœ‰ä¸€ä¸ªåŠæ³•è‡ªåŠ¨é€‰å‡ºä¸»èŠ‚ç‚¹ã€‚

é€šè¿‡æ‰€æœ‰æ—¥å¿—ç»ç”±ä¸»èŠ‚ç‚¹å¤åˆ¶è¾¾åˆ°å…¨å±€æ—¶åºæ¶ˆæ¯

â€‹

â€‹

\### raftlibä¸åº”ç”¨å±‚çš„å…³ç³»
![image.png](assert/1637310322775-b0e4448f-b69c-4a7c-89ef-d26bd09a7988.png)

\# ç†è®ºéƒ¨åˆ†

ğŸªœï¼šé—®é¢˜å¯¼å‘ï¼Œä¿æŒæ€è€ƒ

\## åŸºæœ¬æ¦‚å¿µ

\### ä¸‰ç§èŠ‚ç‚¹ç±»å‹
â€‹

è§’è‰² leaderä¸» candidateå€™é€‰äºº followerä»ï¼Œèµ·å§‹çŠ¶æ€éƒ½æ˜¯follower

![image.png](assert/1636944322993-0d107e15-3baa-40c7-8ea6-10028c76126a.png)

â€‹

\### å‡ ç§å®šæ—¶å™¨

å‡ ä¸ªå®šæ—¶å™¨åŠè¶…æ—¶æ—¶é—´

election time out é€‰ä¸¾å®šæ—¶å™¨æ—¶é—´ï¼Œfollowerè¶…è¿‡næœªæ”¶åˆ°ä¸»çš„å¿ƒè·³ï¼Œå°†è‡ªå·±åˆ‡æ¢ä¸ºå€™é€‰äººå¼€å§‹é€‰ä¸¾ï¼ˆé€ åå•¦ï¼‰

å¿ƒè·³å®šæ—¶å™¨ heartbeat ä¸»èŠ‚ç‚¹å®šæœŸç»™followerå‘é€å¿ƒè·³æ¶ˆæ¯ï¼ˆè€å­è¿˜æˆ–è€…è¯´ç»™æˆ‘è€å®ç‚¹ï¼‰

é€‰ä¸¾å®šæ—¶å™¨ï¼Œcandidate å¼€å§‹é€‰ä¸¾è¶…è¿‡æ—¶é—´æœªæˆåŠŸé€‰å‡ºleaderï¼Œé‡æ–°å¼€å¯é€‰ä¸¾ã€‚

â€‹

å¹¿æ’­æ—¶é—´ï¼ˆbroadcastTimeï¼‰ << é€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼ˆelectionTimeoutï¼‰ << å¹³å‡æ•…éšœé—´éš”æ—¶é—´ï¼ˆMTBFï¼‰

â€‹

â€‹

\### ä¸€ä¸ªéšæœºæ—¶é—´

é€‰ä¸¾è¶…æ—¶æ—¶é—´ 150-300ms é¿å…æ¥æ´»é”

é™ä½å¹³åˆ†é€‰ç¥¨æ¦‚ç‡ï¼Œä½†æ˜¯ä»ç„¶ä¸å¯èƒ½

ä¾‹å­ï¼šA B C å‡ ä¹åŒæ—¶æˆä¸ºå€™é€‰äººï¼Œå„è‡ªæŠ•è‡ªå·±ä¸€ç¥¨ï¼Œæ²¡äººæœ‰æ‹¿åˆ°2ç¥¨

\### å‡ ç§RPC
æŠ•ç¥¨ è¯·æ±‚/å“åº”

è¿½åŠ æ—¥å¿— è¯·æ±‚/å“åº”

å®‰è£…å¿«ç…§ è¯·æ±‚/å“åº”

æˆå‘˜å˜åŒ–ï¼ˆé…ç½®å˜æ›´) è¯·æ±‚/å“åº”

é¢„é€‰ä¸¾ è¯·æ±‚/å“åº”

\### çŠ¶æ€æœº state machine åŠæœåŠ¡state
termæ˜¯å•è°ƒé€’å¢çš„

\*\*commitIndex\*\* æŒ‡log[] æ•°ç»„åæ ‡ï¼Œå·²å¤åˆ¶åˆ°å¤šæ•°ä»èŠ‚ç‚¹ã€‚

\*\*lastApplied\*\* æ—¥å¿—åºåˆ—åˆ°çŠ¶æ€æœºçš„ä½ç½®

ä¸»èŠ‚ç‚¹ä¿®æ”¹commitIndexçš„å‰ææ˜¯log æˆåŠŸå¤åˆ¶åˆ°å¤§å¤šæ•°èŠ‚ç‚¹

followerèŠ‚ç‚¹æ ¹æ®ä¸»èŠ‚ç‚¹å‘é€æ¥çš„leaderCommit ä¿®æ”¹
\> 1ï¼Œå¦‚æœcommitIndex > lastAppliedï¼Œåˆ™ lastApplied é€’å¢ï¼Œå¹¶å°†log[lastApplied]åº”ç”¨åˆ°çŠ¶æ€æœºä¸­ï¼ˆ5.3 èŠ‚ï¼‰
\> 2.å¦‚æœæ¥æ”¶åˆ°çš„ RPC è¯·æ±‚æˆ–å“åº”ä¸­ï¼Œä»»æœŸå·T > currentTermï¼Œåˆ™ä»¤ currentTerm = Tï¼Œå¹¶åˆ‡æ¢ä¸ºè·Ÿéšè€…çŠ¶æ€ï¼ˆ5.1 èŠ‚ï¼‰

ä¸ºäº†ç†è§£å…¨éƒ¨æœåŠ¡å™¨è§„åˆ™2ï¼Œæ‹ŸäººåŒ–æ¯”å–»ä»¥ä¸‹ï¼Œå‡è®¾æ¡ƒèŠ±æºå‡ºæ¥çš„å°åä»¥ä¸ºç”Ÿæ´»åœ¨æ¸…æœï¼Œå½“ä»–é‡åˆ°æ°‘å›½æ—¶æœŸçš„äººï¼Œä»–çš„è®¤çŸ¥ä¹Ÿä¼šæåˆ°æ°‘å›½ï¼Œæ‰€æœ‰äººéƒ½å¯äº¤å¾€çš„æ—¶å€™ï¼Œå¤§å®¶éƒ½æ˜¯ä¸€ä¸ªtermæ—¶ä»£çš„äººäº†ã€‚

![image.png](assert/1637307802969-39661b54-ca0a-454d-b71a-7cb9f1533e0b.png)

![image.png](assert/1637230997852-b7a1fe1c-7c16-4e18-8ec7-7148a5a30d5b.png)

\## æ—¥å¿—å¤åˆ¶çš„è¿‡ç¨‹æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ

\*\*ä¸€èˆ¬åœºæ™¯\*\*

ä¸»èŠ‚ç‚¹RPCä»èŠ‚ç‚¹ï¼Œå¤åˆ¶æ—¥å¿—ï¼Œåº”ç”¨åˆ°çŠ¶æ€æœº

![image.png](assert/1637289964787-ddf4e9fd-b0b1-4cc7-8e1e-4a0270ca4f91.png)
\> Leaderä¸ºæ¯ä¸ªFollowerç»´æŠ¤ä¸€ä¸ªnextIdï¼Œæ ‡ç¤ºä¸‹ä¸€ä¸ªè¦å‘é€çš„logIndexã€‚Followeræ¥æ”¶åˆ°AppendEntriesä¹‹åä¼šè¿›è¡Œä¸€äº›ä¸€è‡´æ€§æ£€æŸ¥ï¼Œæ£€æŸ¥AppendEntriesä¸­æŒ‡å®šçš„LastLogIndexæ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´å°±ä¼šå‘Leaderè¿”å›å¤±è´¥ã€‚Leaderæ¥æ”¶åˆ°å¤±è´¥ä¹‹åï¼Œä¼šå°†nextIdå‡1ï¼Œé‡æ–°è¿›è¡Œå‘é€ï¼Œç›´åˆ°æˆåŠŸã€‚è¿™ä¸ªå›æº¯çš„è¿‡ç¨‹å®é™…ä¸Šå°±æ˜¯å¯»æ‰¾Followerä¸Šæœ€åä¸€ä¸ªCommittedId

\*\*ä¸»èŠ‚ç‚¹å‚æ•°ç”Ÿæˆè¿‡ç¨‹\*\*

ä¸»èŠ‚ç‚¹ä¿å­˜çš„ nextIndex[] matchIndex[]å°±æ˜¯ç”¨æ¥å¤åˆ¶æ—¥å¿—ä½¿ç”¨

preLogIndex,preLogTerm entries[]å‰é¢çš„æ—¥å¿—termå’Œindex,ç”¨äºä»èŠ‚ç‚¹è¿›è¡Œæ ¡éªŒï¼Œå°±åƒä¸€ä¸ªé“¾è¦æ‰£ä¸Šï¼Œä¸¾ä¾‹ï¼šä¸»èŠ‚ç‚¹æ—¥å¿—[a,b,c,d,e,f]ï¼Œ ä»èŠ‚ç‚¹æ—¥å¿—[a,b,k] å‘é€entries:[ c,d] preLogIndex:b ä»èŠ‚ç‚¹æ ¡éªŒä¸ä¼šç›²ç›®æ¥åœ¨kåé¢ï¼Œè€Œæ˜¯æ£€æŸ¥åˆ°åŒæ ·ä½ç½®å€¼å†²çªï¼Œkä¼šè¢«åˆ é™¤ï¼Œæ¥åœ¨båé¢

nextIndex[]è®°å½•æ‰€æœ‰èŠ‚ç‚¹ï¼Œä¸‹æ¬¡è¯·æ±‚éœ€è¦æºå¸¦çš„logä½ç½® ï¼ˆåˆå§‹å€¼ä¸ºé¢†å¯¼äººæœ€åçš„æ—¥å¿—æ¡ç›®çš„ç´¢å¼•+1ï¼‰

matchIndex[] è®°å½•æ‰€æœ‰èŠ‚ç‚¹ï¼Œå·²ç»å¤åˆ¶åˆ°è¯¥æœåŠ¡å™¨çš„æœ€é«˜æ—¥å¿—æ¡ç›®çš„ç´¢å¼•ï¼ˆåˆå§‹å€¼ä¸º0ï¼Œå•è°ƒé€’å¢ï¼‰

å¤åˆ¶è¯·æ±‚åŠå“åº”å¯èƒ½æ˜¯å¹¶å‘çš„ ã€‚ä¸ºäº†ç†è§£ä»–ä»¬ç›´æ¥çš„å¿…è¦æ€§ ä¸¾ä¾‹ï¼š

ä¸»èŠ‚ç‚¹æ—¥å¿—ï¼š[1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œ5ï¼Œ6]

ä»èŠ‚ç‚¹æ—¥å¿—: [1,2]

æ­¤æ—¶matchIndex[ä»èŠ‚ç‚¹] = 1

è¯·æ±‚1:[3,4] è¯·æ±‚2[5,6]

è¯·æ±‚1å¤„ç†æˆåŠŸåè®°å½•matchIndex[ä»]=3

\*\*â€‹\*\*

\*\*æ¥å—è€…å®ç°\*\*
\> 1\. è¿”å›å‡ å¦‚æœé¢†å¯¼äººçš„ä»»æœŸå°äºæ¥æ”¶è€…çš„å½“å‰ä»»æœŸï¼ˆè¯‘è€…æ³¨ï¼šè¿™é‡Œçš„æ¥æ”¶è€…æ˜¯æŒ‡è·Ÿéšè€…æˆ–è€…å€™é€‰äººï¼‰ï¼ˆ5.1 èŠ‚ï¼‰
\> 1\. è¿”å›å‡ å¦‚æœæ¥æ”¶è€…æ—¥å¿—ä¸­æ²¡æœ‰åŒ…å«è¿™æ ·ä¸€ä¸ªæ¡ç›® å³è¯¥æ¡ç›®çš„ä»»æœŸåœ¨ prevLogIndex ä¸Šèƒ½å’Œ prevLogTerm åŒ¹é…ä¸Š ï¼ˆè¯‘è€…æ³¨ï¼šåœ¨æ¥æ”¶è€…æ—¥å¿—ä¸­ å¦‚æœèƒ½æ‰¾åˆ°ä¸€ä¸ªå’Œ prevLogIndex ä»¥åŠ prevLogTerm ä¸€æ ·çš„ç´¢å¼•å’Œä»»æœŸçš„æ—¥å¿—æ¡ç›® åˆ™ç»§ç»­æ‰§è¡Œä¸‹é¢çš„æ­¥éª¤ å¦åˆ™è¿”å›å‡ï¼‰ï¼ˆ5.3 èŠ‚ï¼‰
\> 1\. å¦‚æœä¸€ä¸ªå·²ç»å­˜åœ¨çš„æ¡ç›®å’Œæ–°æ¡ç›®ï¼ˆè¯‘è€…æ³¨ï¼šå³åˆšåˆšæ¥æ”¶åˆ°çš„æ—¥å¿—æ¡ç›®ï¼‰å‘ç”Ÿäº†å†²çªï¼ˆå› ä¸ºç´¢å¼•ç›¸åŒï¼Œä»»æœŸä¸åŒï¼‰ï¼Œé‚£ä¹ˆå°±åˆ é™¤è¿™ä¸ªå·²ç»å­˜åœ¨çš„æ¡ç›®ä»¥åŠå®ƒä¹‹åçš„æ‰€æœ‰æ¡ç›® ï¼ˆ5.3 èŠ‚ï¼‰
\> 1\. è¿½åŠ æ—¥å¿—ä¸­å°šæœªå­˜åœ¨çš„ä»»ä½•æ–°æ¡ç›®
\> 1\. å¦‚æœé¢†å¯¼äººçš„å·²çŸ¥å·²æäº¤çš„æœ€é«˜æ—¥å¿—æ¡ç›®çš„ç´¢å¼•å¤§äºæ¥æ”¶è€…çš„å·²çŸ¥å·²æäº¤æœ€é«˜æ—¥å¿—æ¡ç›®çš„ç´¢å¼•ï¼ˆleaderCommit > commitIndexï¼‰ï¼Œåˆ™æŠŠæ¥æ”¶è€…çš„å·²çŸ¥å·²ç»æäº¤çš„æœ€é«˜çš„æ—¥å¿—æ¡ç›®çš„ç´¢å¼•commitIndex é‡ç½®ä¸º é¢†å¯¼äººçš„å·²çŸ¥å·²ç»æäº¤çš„æœ€é«˜çš„æ—¥å¿—æ¡ç›®çš„ç´¢å¼• leaderCommit æˆ–è€…æ˜¯ ä¸Šä¸€ä¸ªæ–°æ¡ç›®çš„ç´¢å¼• å–ä¸¤è€…çš„æœ€å°å€¼
\>
â€‹

â€‹

\*\*åœºæ™¯ï¼šæ–°ä»èŠ‚ç‚¹åŠ å…¥\*\*

æ˜¾ç„¶æ‰€æœ‰æ—¥å¿—éƒ½å¤åˆ¶ä¸€éæ€§èƒ½ä¼šå¾ˆå·®

ä¾‹å¦‚æ—¥å¿—æ“ä½œ

x=1

x=2

x=3

éƒ½å·²æäº¤

æ–°èŠ‚ç‚¹åŠ å…¥æ—¶ï¼Œæœ€å¥½ç›´æ¥å¤åˆ¶x=3ç»™å®ƒï¼Œè¿™ä¸ªå°±å«åšå¿«ç…§snapshotï¼Œç”Ÿæˆå¿«ç…§çš„è¿‡ç¨‹å«åšï¼šlog compaction æ—¥å¿—å‹ç¼©ï¼Œè¿™é‡Œæš‚æ—¶ä¸æ·±å…¥åˆ°è¿™ä¸¤ä¸ªå­é—®é¢˜ã€‚ğŸ‘€

å¿«ç…§ä¸­åŒ…å«äº†æœ€åç´¢å¼•çš„ä½ç½®indexå’Œä»»æœŸå·term

![image.png](assert/1637305097713-c7591ed0-0046-4f0e-9396-47d910ae9724.png)

å¿«ç…§åœ¨ä¸»ä»åˆ†åˆ«æ‰§è¡Œï¼Œä¸»è¦æ˜¯ä¸ºäº†èŠ‚çº¦å­˜å‚¨ç©ºé—´ã€‚

\*\*â€‹\*\*

\## é€‰ä¸¾è¿‡ç¨‹æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ

![image.png](assert/1637294886275-21e10229-40bd-4433-85ac-ca640cb2fa26.png)
\> 1\. å¦‚æœnow â€“ lastLeaderUpdateTimestamp < elect\_timeoutï¼Œå¿½ç•¥è¯·æ±‚
\> 1\. å¦‚æœreq.term < currentTermï¼Œå¿½ç•¥è¯·æ±‚ã€‚
\> 1\. å¦‚æœreq.term > currentTermï¼Œè®¾ç½®req.termåˆ°currentTermä¸­ï¼Œå¦‚æœæ˜¯Leaderå’ŒCandidateè½¬ä¸ºFollowerã€‚
\> 1\. å¦‚æœreq.term == currentTermï¼Œå¹¶ä¸”æœ¬åœ°voteForè®°å½•ä¸ºç©ºæˆ–è€…æ˜¯ä¸voteè¯·æ±‚ä¸­termå’ŒCandidateIdä¸€è‡´ï¼Œreq.lastLogIndex > lastLogIndexï¼Œå³Candidateæ•°æ®æ–°äºæœ¬åœ°åˆ™åŒæ„é€‰ä¸»è¯·æ±‚ã€‚
\> 1\. å¦‚æœreq.term == currentTermï¼Œå¦‚æœæœ¬åœ°voteForè®°å½•éç©ºå¹¶ä¸”æ˜¯ä¸voteè¯·æ±‚ä¸­termä¸€è‡´CandidateIdä¸ä¸€è‡´ï¼Œåˆ™æ‹’ç»é€‰ä¸»è¯·æ±‚ã€‚
\> 1\. å¦‚æœlastLogTerm > req.lastLogTermï¼Œæœ¬åœ°æœ€åä¸€æ¡Logçš„Termå¤§äºè¯·æ±‚ä¸­çš„lastLogTermï¼Œè¯´æ˜candidateä¸Šæ•°æ®æ¯”æœ¬åœ°æ—§ï¼Œæ‹’ç»é€‰ä¸»è¯·æ±‚ã€‚

ä¸»èƒ½è”ç³»å¤§å¤šæ•°ï¼ˆä¸€åŠï¼‰æ‰å¯ç”¨ï¼Œä¸ç„¶å®¢æˆ·ç«¯æäº¤çš„è¯·æ±‚æ— æ³•æäº¤ï¼Œä¿è¯äº†å¼ºä¸€è‡´æ€§

å½“ä¸»æ¥æ”¶åˆ°termæ¯”å½“å‰çš„å¤§æ—¶å˜æˆfllower

ä¸€ä¸ªfllowerä¸å¯èƒ½åŒæ—¶ç»™ä¸¤ä¸ªå€™é€‰è€…æŠ•ç¥¨

ä¸€ä¸ªä»èŠ‚ç‚¹è¶…æ—¶æœªæ¥åˆ°ä¸»èŠ‚ç‚¹å¿ƒè·³å˜ä¸ºå€™é€‰term+1å¼€å§‹é€‰ä¸¾

â€‹

æ¯”å¦‚å®¢æˆ·ç«¯æäº¤Aå­˜å…¥100ï¼Œ

è¿™é‡Œéšå«çš„å‰ææ˜¯èŠ‚ç‚¹è‚¯å®šæ˜¯æœ‰å…¶ä»–èŠ‚ç‚¹çš„åœ°å€çš„ã€‚

é€‰å‡ºçš„æ–°çš„ä¸»èŠ‚ç‚¹è¦åŒ…å«è€ä¸»èŠ‚ç‚¹çš„å·²æäº¤çš„æ—¥å¿—ï¼Œè¿™å°±å¯¹ä¸»èŠ‚ç‚¹æäº¤æœ‰äº†è¦æ±‚

â€‹

â€‹

ä¸»èŠ‚ç‚¹é€€ä½æ—¶æœº step down

â€‹

\## å®‰å…¨è§„åˆ™æ˜¯ä»€ä¹ˆï¼Ÿå¦‚æœä¿è¯çš„ï¼Ÿ
æ‰€è°“å®‰å…¨è§„åˆ™æŒ‡çš„æ˜¯å¯¹ä»¥ä¸Šé€‰ä¸¾ï¼Œæ—¥å¿—å¤åˆ¶æ·»åŠ çš„ä¸€äº›é™åˆ¶æ¡ä»¶ä»¥ä¿è¯ä¸‹é¢5æ¡Raftç‰¹æ€§ã€‚
\> \- é€‰ä¸¾å®‰å…¨ç‰¹æ€§Election Safetyï¼šç»™å®šTermä¸‹æœ€å¤šåªæœ‰ä¸€ä¸ªLeaderè¢«é€‰ä¸¾å‡ºæ¥ã€‚

\> \- é¢†å¯¼äººåªé™„åŠ åŸåˆ™Leader Append-Onlyï¼šLeaderä¸ä¼šè¦†ç›–æˆ–è€…æ˜¯åˆ é™¤è‡ªå·±çš„Entryï¼Œåªä¼šè¿›è¡ŒAppendã€‚
\> \- æ—¥å¿—åŒ¹é…åŸåˆ™Log Matchingï¼šå¦‚æœä¸¤ä¸ªLogæ‹¥æœ‰ç›¸åŒçš„Termå’ŒIndexï¼Œé‚£ä¹ˆç»™å®šIndexä¹‹å‰çš„LogEntryéƒ½æ˜¯ç›¸åŒçš„ã€‚
\> \- å¦‚æœä¸¤ä¸ªLogæ‹¥æœ‰ç›¸åŒçš„Termå’ŒIndexï¼Œé‚£ä¹ˆä»–ä»¬æ‹¥æœ‰ç›¸åŒçš„å†…å®¹
\> \- å¦‚æœä¸¤ä¸ªLogæ‹¥æœ‰ç›¸åŒçš„termå’ŒIndexï¼Œé‚£ä¹ˆä¹‹å‰çš„Logä¹Ÿéƒ½æ˜¯ä¸€æ ·çš„
\> \- é¢†å¯¼äººå®Œæ•´ç‰¹æ€§Leader Completenessï¼šå¦‚æœä¸€æ¡LogEntryåœ¨æŸä¸ªTermä¸‹è¢«Commitäº†ï¼Œé‚£ä¹ˆè¿™æ¡LogEntryå¿…ç„¶å­˜åœ¨äºåé¢Termçš„Leaderä¸­ã€‚
\> \- çŠ¶æ€æœºå®‰å…¨ç‰¹æ€§State Machine Safetyï¼šå¦‚æœä¸€ä¸ªèŠ‚ç‚¹å·²ç»Applyäº†ä¸€æ¡LogEntryåˆ°çŠ¶æ€æœºï¼Œé‚£ä¹ˆå…¶ä»–èŠ‚ç‚¹ä¸ä¼šå‘çŠ¶æ€æœºä¸­Applyç›¸åŒIndexä¸‹çš„ä¸åŒçš„LogEntryã€‚

é€‰ä¸¾è§„åˆ™ï¼šé¢†å¯¼äººéƒ½å¿…é¡»å­˜å‚¨æ‰€æœ‰å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®
\> Raft ä½¿ç”¨æŠ•ç¥¨çš„æ–¹å¼æ¥é˜»æ­¢ä¸€ä¸ªå€™é€‰äººèµ¢å¾—é€‰ä¸¾é™¤éè¿™ä¸ªå€™é€‰äººåŒ…å«äº†æ‰€æœ‰å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®ã€‚å€™é€‰äººä¸ºäº†èµ¢å¾—é€‰ä¸¾å¿…é¡»è”ç³»é›†ç¾¤ä¸­çš„å¤§éƒ¨åˆ†èŠ‚ç‚¹ï¼Œè¿™æ„å‘³ç€æ¯ä¸€ä¸ªå·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®åœ¨è¿™äº›æœåŠ¡å™¨èŠ‚ç‚¹ä¸­è‚¯å®šå­˜åœ¨äºè‡³å°‘ä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚å¦‚æœå€™é€‰äººçš„æ—¥å¿—è‡³å°‘å’Œå¤§å¤šæ•°çš„æœåŠ¡å™¨èŠ‚ç‚¹ä¸€æ ·æ–°ï¼ˆè¿™ä¸ªæ–°çš„å®šä¹‰ä¼šåœ¨ä¸‹é¢è®¨è®ºï¼‰ï¼Œé‚£ä¹ˆä»–ä¸€å®šæŒæœ‰äº†æ‰€æœ‰å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®ã€‚è¯·æ±‚æŠ•ç¥¨ RPC å®ç°äº†è¿™æ ·çš„é™åˆ¶ï¼šRPC ä¸­åŒ…å«äº†å€™é€‰äººçš„æ—¥å¿—ä¿¡æ¯ï¼Œç„¶åæŠ•ç¥¨äººä¼šæ‹’ç»æ‰é‚£äº›æ—¥å¿—æ²¡æœ‰è‡ªå·±æ–°çš„æŠ•ç¥¨è¯·æ±‚ã€‚

æ€»ç»“ï¼šæŠ•ç¥¨é€»è¾‘åŠ ä¸€ä¸ªæ£€æŸ¥ï¼Œå€™é€‰è€…çš„æ—¥å¿—æ¯”æŠ•ç¥¨è€…æ›´æ–°ï¼ˆcommitId) æŠ•ç¥¨è€…æ‰ä¼šæŠ•èµæˆç¥¨

æ—¥å¿—å¤åˆ¶è§„åˆ™ï¼šé¢†å¯¼äººä¸åˆ é™¤è‡ªå·±çš„æ—¥å¿—ï¼Œåªè¿›è¡Œappend

ä¸»èŠ‚ç‚¹å†™å¤§å¤šæ•°èŠ‚ç‚¹æˆåŠŸcommit

å€™é€‰äººindexå¤§äºå¤§å¤šæ•°èŠ‚ç‚¹indexæ‰èƒ½æŠ•ç¥¨æˆåŠŸ

ä¸»èŠ‚ç‚¹ä¸åˆ é™¤è‡ªå·±çš„æ—¥å¿—ã€‚

ä»¥ä¸Šä¸‰ç‚¹å¾—å‡ºç»“è®ºï¼š

commitæ—¥å¿—ä¸ä¼šä¸¢å¤±ã€‚

è€ä¸»èŠ‚ç‚¹æœªcommitlogå¯èƒ½ä¼šè¢«è¦†ç›–ã€‚

â€‹

\## ä¸ºä»€ä¹ˆéœ€è¦æˆå‘˜å˜åŒ–ç®¡ç†ï¼Ÿ

è‡ªåŠ¨åŒ–å¤„ç†é…ç½®æ”¹å˜ã€‚

è¯•æƒ³ä¸€ä¸ªåœºæ™¯ï¼Œä¸€ä¸ªæœ‰ä¸‰ä¸ªèŠ‚ç‚¹ A B C ï¼Œä¸»èŠ‚ç‚¹Aï¼Œä¹‹ååŠ å…¥ E F ï¼Œåœ¨é€‰ä¸¾çš„æ—¶å€™ï¼ŒC E F æ„æˆå¤šæ•°é€‰ä¸¾Cä¸ºä¸»ï¼Œä½†æ˜¯Cå¯èƒ½æ²¡å®Œå…¨coomitè€ä¸»å·²commitçš„æ—¥å¿—ï¼ŒCå¤åˆ¶ç»™è€ä¸»Aæ—¥å¿—çš„æ—¶å€™ï¼Œå†²çªäº†ã€‚

â€‹

è§£æ³•1ï¼Œæ–°æˆå‘˜åŠ å…¥æ·»åŠ ä¸€ä¸ªç‰¹æ®Šæ—¥å¿—æ ‡è®°ï¼Œæ–°ä¸»æ²¡åº”ç”¨å®Œç‰¹æ®Šæ ‡è®°ï¼ˆconfigration)E Fä¸é€‰ä»–ï¼Œä¸»èŠ‚ç‚¹å¤„ç†ç‰¹æ®Šæ ‡è®°ï¼Œå°†ä¹‹å‰çš„æ—¥å¿—åº”ç”¨åˆ°æ–°åŠ å…¥èŠ‚ç‚¹ï¼Œä¹‹åcommitç‰¹æ®Šæ ‡è®°

è§£æ³•2ï¼Œ

\## ä¸ºä»€ä¹ˆéœ€è¦é¢„é€‰ä¸¾ï¼Ÿ é¢„é€‰ä¸¾çš„è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ
\> ç½‘ç»œåˆ’åˆ†ä¼šå¯¼è‡´æŸä¸ªèŠ‚ç‚¹çš„æ•°æ®ä¸é›†ç¾¤æœ€æ–°æ•°æ®å·®è·æ‹‰å¤§ï¼Œä½†æ˜¯termå› ä¸ºä¸æ–­å°è¯•é€‰ä¸»è€Œå˜å¾—å¾ˆå¤§ã€‚ç½‘ç»œæ¢å¤ä¹‹åï¼ŒLeaderå‘å…¶è¿›è¡Œreplicateå°±ä¼šå¯¼è‡´Leaderå› ä¸ºtermè¾ƒå°è€Œstepdownã€‚è¿™ç§æƒ…å†µå¯ä»¥å¼•å…¥pre-voteæ¥é¿å…ã€‚followeråœ¨è½¬å˜ä¸ºCandidateä¹‹å‰ï¼Œå…ˆä¸é›†ç¾¤èŠ‚ç‚¹é€šä¿¡ï¼Œè·å¾—é›†ç¾¤Leaderæ˜¯å¦å­˜æ´»çš„ä¿¡æ¯ï¼Œå¦‚æœå½“å‰é›†ç¾¤æœ‰Leaderå­˜æ´»ï¼Œfollowerå°±ä¸ä¼šè½¬å˜ä¸ºCandidateï¼Œä¹Ÿä¸ä¼šå¢åŠ termã€‚

åŒ¡æ‰¶æ±‰å®¤

â€‹

ABC ED åˆ†åŒº Eå¼€å§‹é€‰ä¸¾æ€»æ˜¯å¤±è´¥ï¼Œterm+++ï¼ŒABCEDæ¢å¤ä¹‹åABCEDåˆå¾—é‡æ–°é€‰ä¸¾ï¼Œå› ä¸ºEæ—¥å¿—è½åå¤ªå¤šè¿˜ä¼šå¤±è´¥ã€‚

å…ˆè”ç³»ç¾¤ä¼—å†ç»„ç»‡ç¾¤ä¼—ã€‚é¢„é€‰ä¸¾å’Œå¤šæ•°é€šä¿¡termä¸åŠ ã€‚

â€‹

â€‹

\## ä»¥å®¹é”™çš„è§†è§’çœ‹é—®é¢˜ï¼Ÿ
ä¸»èŠ‚ç‚¹commitä¸ºæ¥åŠapplyåˆ°å®¢æˆ·ç«¯ï¼ˆåº”ç”¨å±‚ï¼‰å®•æœºäº†ï¼Œä¹‹åé€‰å‡ºäº†æ–°çš„ä¸»èŠ‚ç‚¹ï¼ŒåŸå…ˆçš„ä¸»èŠ‚ç‚¹æ€ä¹ˆåŠï¼Ÿæ–°çš„ä¸»èŠ‚ç‚¹åˆæ˜¯å¦‚ä½•é€‰å‡ºæ¥çš„ï¼Œåˆæ˜¯å¦‚ä½•ä¿è¯ä¸ä¸¢å¤±åŸä¸»èŠ‚ç‚¹commitçš„æ—¥å¿—çš„ï¼Ÿ\*è¿™ä¸ªæ˜¯æœ€å¤æ‚çš„ç‚¹ã€‚

\# æºç éƒ¨åˆ†
etcd å®ç° [https://github.com/etcd-io/etcd/tree/master/raft](https://github.com/etcd-io/etcd/tree/master/raft)

â€‹

è§‚å…¶å¤§è¦ï¼Œå…ˆæœ‰æ•´ä½“çš„è§†è§’ã€‚

â€‹

![image.png](assert/1638015068863-649ca6ee-29f1-4422-a89a-ca49feaed402.png)

\## èƒŒæ™¯çŸ¥è¯†
go channel

go http

etcd wal [WALä»€ä¹ˆæ˜¯ ](http://mysql.taobao.org/monthly/2017/03/02/) Write-Ahead Logging å…ˆå†™æ—¥å¿—ï¼Œå†å†™æ•°æ®

\## æ·±å…¥å®ç°ç»†èŠ‚
â€‹

\### å¯åŠ¨è¿‡ç¨‹
æ„é€ channel

newRaftNode()=> å†…éƒ¨è°ƒç”¨ startRaft()

-raft.StartNode =>å†…éƒ¨è°ƒç”¨.run å¯åŠ¨nodeäº‹ä»¶å¾ªç¯[å…³é”®ğŸŒŸ]

-raftNode.serveRaft() å¯åŠ¨rafthttp é€šä¿¡server

-raftNode.serveChannels() å¯åŠ¨æŒä¹…åŒ–å­˜å‚¨äº‹ä»¶å¾ªç¯ï¼ˆç­‰ä¸‹å±‚ï¼‰ï¼Œå¯åŠ¨httpAPIå¤„ç†äº‹ä»¶å¾ªç¯ï¼ˆç­‰ä¸Šå±‚ï¼‰

newKVStore å¯åŠ¨commit äº‹ä»¶å¾ªç¯

serveHttpKVAPI å¯åŠ¨httpAPI server

â€‹

â€‹

\###

\### PUT å¤„ç†è¿‡ç¨‹
ServeHTTP=>

kvstore.Propose()=> å†™proposeC

event loop in raftNode, node.Propose =>

node å†…éƒ¨è°ƒç”¨ stepWait => stepWithWaitOption => å†™propc

event loop in node, start by run ,raft.Step =>

raft å†…éƒ¨è°ƒç”¨step å¯èƒ½æ˜¯stepLeaderï¼ŒstepFollower,stepCandidate

\|\> stepLeader raftLog.append()

event loop in node, start by run , =>readyc å†™å…¥ ä¸Šå±‚é€šè¿‡channelå–å‡ºcommitçš„

\###

â€‹

\###

\### æ¶ˆæ¯ç±»å‹
[å‚è€ƒ](https://www.codedump.info/post/20180922-etcd-raft/#msgunreachable%E6%B6%88%E6%81%AF)

Messageæ¶ˆæ¯ä¸ä»…æ˜¯èŠ‚ç‚¹é—´é€šä¿¡çš„åºåˆ—åŒ–æ•°æ®å°è£…

ä¹Ÿæ˜¯raftä¸åŒå±‚ï¼ˆåº”ç”¨å±‚-node-raftï¼‰è°ƒç”¨çš„æºå¸¦å‚æ•°å°è£…

â€‹

\`\`\`
const (
 MsgHup MessageType = 0 //ä¸ç”¨äºèŠ‚ç‚¹é—´é€šä¿¡ï¼Œä»…ç”¨äºå‘é€ç»™æœ¬èŠ‚ç‚¹è®©æœ¬èŠ‚ç‚¹è¿›è¡Œé€‰ä¸¾
 MsgBeat MessageType = 1 //ä¸ç”¨äºèŠ‚ç‚¹é—´é€šä¿¡ï¼Œä»…ç”¨äºleaderèŠ‚ç‚¹åœ¨heartbeatå®šæ—¶å™¨åˆ°æœŸæ—¶å‘é›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹å‘é€å¿ƒè·³æ¶ˆæ¯
 MsgProp MessageType = 2 //raftåº“ä½¿ç”¨è€…æè®®ï¼ˆproposeï¼‰æ•°æ®
 MsgApp MessageType = 3 //ç”¨äºleaderå‘é›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹åŒæ­¥æ•°æ®çš„æ¶ˆæ¯ app=appendç®€å†™
 MsgAppResp MessageType = 4
 MsgVote MessageType = 5 //èŠ‚ç‚¹æŠ•ç¥¨ç»™è‡ªå·±ä»¥è¿›è¡Œæ–°ä¸€è½®çš„é€‰ä¸¾
 MsgVoteResp MessageType = 6
 MsgSnap MessageType = 7 // ç”¨äºleaderå‘followeråŒæ­¥æ•°æ®ç”¨çš„å¿«ç…§æ¶ˆæ¯
 MsgHeartbeat MessageType = 8 //ç”¨äºleaderå‘followerå‘é€å¿ƒè·³æ¶ˆæ¯
 MsgHeartbeatResp MessageType = 9
 MsgUnreachable MessageType = 10 //ç”¨äºåº”ç”¨å±‚å‘raftåº“æ±‡æŠ¥æŸä¸ªèŠ‚ç‚¹å½“å‰å·²ä¸å¯è¾¾
 MsgSnapStatus MessageType = 11 //ç”¨äºåº”ç”¨å±‚å‘raftåº“æ±‡æŠ¥æŸä¸ªèŠ‚ç‚¹å½“å‰æ¥æ”¶å¿«ç…§çŠ¶æ€
 MsgCheckQuorum MessageType = 12 //ç”¨äºleaderæ£€æŸ¥é›†ç¾¤å¯ç”¨æ€§çš„æ¶ˆæ¯
 MsgTransferLeader MessageType = 13 //ç”¨äºè¿ç§»leader
 MsgTimeoutNow MessageType = 14 //leaderè¿ç§»æ—¶ï¼Œå½“æ–°æ—§leaderçš„æ—¥å¿—æ•°æ®åŒæ­¥åï¼Œæ—§leaderå‘æ–°leaderå‘é€è¯¥æ¶ˆæ¯é€šçŸ¥å¯ä»¥è¿›è¡Œè¿ç§»äº†
 MsgReadIndex MessageType = 15 //ç”¨äºè¯»ä¸€è‡´æ€§çš„æ¶ˆæ¯
 MsgReadIndexResp MessageType = 16
 MsgPreVote MessageType = 17 // èŠ‚ç‚¹æŠ•ç¥¨ç»™è‡ªå·±ä»¥è¿›è¡Œæ–°ä¸€è½®çš„é€‰ä¸¾
 MsgPreVoteResp MessageType = 18
)
\`\`\`

\### æŠ•ç¥¨è¿‡ç¨‹åˆ†æ

\### leader ç®¡ç†followerçš„çŠ¶æ€
![image.png](assert/1637922062629-c3c59ae8-003a-4817-806d-2b533f431e73.png)

\### è®¾è®¡æ¨¡å¼ä½“ç°
â€‹

æ§åˆ¶åè½¬ï¼Œstorageæ¥å£

é€šä¿¡è€Œä¸æ˜¯å…±äº«å†…å­˜ foräº‹ä»¶å¾ªç¯ channelé€šä¿¡

å±‚ä¸å±‚ä¹‹é—´é€šè¿‡channelé€šä¿¡ï¼Œselectäº‹ä»¶å¾ªç¯ä¾¦å¬channel

\# æ€»ç»“

å­¦ä¹ å†ç¨‹

çº·ç¹å¤æ‚ä¸å¯èƒ½äº‹æ— å·¨ç»†çŸ­æ—¶é—´å†…å…¨éƒ¨ææ¸…æ¥š,å­¦ä¹ é‡ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ

æ¦‚å¿µï¼ˆæŠ½è±¡ï¼‰ï¼Œç»„ä»¶åŠå…³ç³»ï¼Œæ•°æ®æµ

æºç é˜…è¯»

çœ‹æ–‡æ¡£ï¼Œçœ‹ä½¿ç”¨ï¼Œæ¢³ç†é«˜å±‚æ¬¡çš„ç»„ä»¶å…³ç³»ï¼Œ

å¼„æ‡‚å•è¯çš„æ„æ€ï¼ˆå•è¯->æ¦‚å¿µ)

â€‹

æ„Ÿæ‚Ÿ

æƒåˆ©æ¥è‡ªä¸‹å±‚çš„æ”¯æŒè€Œä¸æ˜¯ä¸Šå±‚çš„æˆæƒ

æƒåˆ©è¿­ä»£çš„åˆæ³•æ€§æ€»è¦æœ‰ä¸Šä¸€ä»£çš„é—å¿—

â€‹

é—®é¢˜

æ‰€æœ‰è¯·æ±‚éƒ½è¦æœ‰ä¸»èŠ‚ç‚¹å‚ä¸ï¼Œä¸»èŠ‚ç‚¹ä¼šæ˜¯ä¸ªæ€§èƒ½ç“¶é¢ˆï¼Œå¦‚æœå®ç°ç³»ç»Ÿæ‰©å®¹æ˜¯ä¸ªé—®é¢˜ï¼Ÿåˆ†åŒºå—ï¼Ÿ

\# å­¦ä¹ èµ„æ–™
è®ºæ–‡ï¼š

å®˜æ–¹ï¼š[https://raft.github.io/](https://raft.github.io/)

ç®€ç‰ˆ 18é¡µï¼š [https://raft.github.io/raft.pdf](https://raft.github.io/raft.pdf) [æ–¯å¦ç¦è¯¾ä»¶](https://web.stanford.edu/~ouster/cgi-bin/papers/raft-atc14) ğŸŒŸ

å®Œæ•´ç‰ˆè®ºæ–‡ 258é¡µï¼š[https://web.stanford.edu/~ouster/cgi-bin/papers/OngaroPhD.pdf](https://web.stanford.edu/~ouster/cgi-bin/papers/OngaroPhD.pdf)

è¯‘æ–‡ï¼š

[https://www.infoq.cn/article/raft-paper](https://www.infoq.cn/article/raft-paper)

[https://github.com/maemual/raft-zh\_cn/blob/master/raft-zh\_cn.md](https://github.com/maemual/raft-zh\_cn/blob/master/raft-zh\_cn.md) ğŸŒŸ

ç½‘ç»œèµ„æºï¼š

åŠ¨ç”»ï¼š

[http://thesecretlivesofdata.com/raft/](http://thesecretlivesofdata.com/raft/) å…¥é—¨ç”¨

[https://github.com/klboke/raft-animation](https://github.com/klboke/raft-animation) ä¸­æ–‡

è§†é¢‘ :

[MIT 6.824](https://www.bilibili.com/video/BV1R7411t71W?p=6) ğŸŒŸ

[The Raft Protocol explained via SQL database \| CockroachDB \| consensus protocol](https://www.youtube.com/watch?v=k5BR9m8o9ec&ab\_channel=CockroachDB)

[Martin Kleppmann Distributed Systems 6.2: Raft](https://www.youtube.com/watch?v=IPnesACYRck&list=PLeKd45zvjcDFUEv\_ohr\_HdUFe97RItdiB&index=18)

[https://www.bilibili.com/video/BV1CK4y127Lj?spm\_id\_from=333.999.0.0](https://www.bilibili.com/video/BV1CK4y127Lj?spm\_id\_from=333.999.0.0)

BLOG:

[https://lessisbetter.site/tags/Raft/](https://lessisbetter.site/tags/Raft/)

å…¶ä»–ï¼š

[braftæ–‡æ¡£ ](https://github.com/baidu/braft/blob/master/docs/cn/raft\_protocol.md) ğŸŒŸ

[ä¸€è‡´æ€§ç®—æ³•ï¼ˆPaxosã€Raftã€ZABï¼‰bittiger](https://www.bilibili.com/video/BV1TW411M7Fx)

[ 32 etcd raft æºç é˜…è¯» ã€ Go å¤œè¯» ã€‘](https://www.youtube.com/watch?v=sL02PsR20gE&t=423s&ab\_channel=TalkGo)

[å­—èŠ‚è·³åŠ¨åº”ç”¨](https://www.infoq.cn/article/qpeIZNMPZvWv6V1L44xJ)

[sofa](https://www.sofastack.tech/projects/sofa-jraft/overview/)

[youtubeæœç´¢](https://www.youtube.com/results?search\_query=raft+algorithm)

[raftæå®¢é‚¦æœç´¢](https://s.geekbang.org/search/c=0/k=raft%20algorithm/t=)

â€‹

\# è‹±æ–‡è¯ä¹‰å¯¹ç…§

\`\`\`
consensus ä¸€è‡´çœ‹æ³•ï¼Œå…±è¯†
rawNode åŸå§‹èŠ‚ç‚¹ï¼Œè¢«Nodeå°è£…
softState ä¸æŒä¹…åŒ–,hardState æŒä¹…åŒ–åˆ°å­˜å‚¨
entry å­˜å‚¨æ—¥å¿—çš„å«æ³•æœ‰æ¡ç›®ï¼Œè´¦ç›®ï¼Œè®°å½•ä¹‹æ„
propose æè®®æ•°æ®ï¼Œå®¢æˆ·ç«¯å†™æ•°æ®
leader election é€‰ä¸¾ä¸»èŠ‚ç‚¹
term ä»£
log replication æ—¥å¿—å¤åˆ¶
safty å®‰å…¨æœºåˆ¶ã€ä¿é™©
election timeout é€‰ä¸¾è¶…æ—¶æ—¶é—´
commitId æäº¤IDä½
advance å‘å‰ç§»åŠ¨
campaign ä»äº‹ç«é€‰æ´»åŠ¨

\`\`\`

[

](https://www.processon.com/view/link/605460bf637689397537fc3e)